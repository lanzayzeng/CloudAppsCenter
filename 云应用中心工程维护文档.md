# 云应用中心工程维护文档

本文主要介绍云应用中心SDK的组件开发、维护和发布，助开发的同事理解。

### 关于模块化

本工程采用ARouter的组件化开发方案，添加模块请遵循 module_<模块名称> 命名规范。

![](http://cmic.tools.bigcloudsys.cn/gitlab/HeCloudPhone/Android/CloudAppsCenter/raw/master/image/%E5%B7%A5%E7%A8%8B%E6%A8%A1%E5%9D%97.png)

### 项目结构
分为3层，宿主层(壳app) / 业务层(module) / 基础层(common)
```
1) 宿主层 负责整合不同的业务层模块构成新的app， 例如：云手机、人民智云

2) 业务层 负责各业务实现，不同业务层由不同人员维护。

    基于业务层特性决定：

        其内的编码结构设计可以各不相同(mvp/mvvm/mvc)

        其内部功能各异，可以引入不同功能特性的的第三方库

        既作为module模块，也可作为独立app进行开发（配置AndroidMainframe，设置入口Activity）



3) 基础层 分为两部分

    a) 基础组件库(basic), 未来公司中所有业务层基础支撑（建设中）,包含各种基础sdk，提取出来的基础控件。此层代码原则是，绝对地不可存在业务代码。

       此层提取后可用于构建其他新app项目。

    b) 基础业务库(module-common)

        b1) 当业务层存在公共数据、类、方法、工具、控件，达到一定程度可以从业务层抽取放进基础业务层以供各业务模块调用。

        b2) 业务层中各业务模块之间项目调用。 module A需要在基础业务层注册服务管理接口，暴露服务。

            module B需要发现服务通过该基础业务层所暴露的服务接口进行module A方法的调用

        b3) 字体库放在此层，涉及字体库的操作从基础组件库集成出类来。
```

#### 阿里ARouter配置
```
    所有业务module中均应该添加配置

    //1
    javaCompileOptions {
        annotationProcessorOptions {
            arguments = [AROUTER_MODULE_NAME: project.getName()]
        }
    }

    //2
    annotationProcessor 'com.alibaba:arouter-compiler:1.2.2'
```


### 资源文件冲突问题
不同module中相同的资源文件名最终合并后会导致命名冲突，遵循添加统一前缀方式进行避免。

<module_name>_<fileType_name>_<page_name>_<resource_name>
<模块名字>_<资源类型缩写>_<页面/类型名字>_<资源名称>

```
Eg:
    module_home 首页模块
        home_activity_main       <首页模块>_<activity类型>_<名片详情页面>
        home_shape_soild_cccccc    <首页模块>_<shape类型>_<类型名称>_<资源名称>
    module_phone  云手机模块
         phone_ic_detail_apple       <云手机模块>_<drawable文件>_<页面名字>_<资源名称>

```

### 云应用SDK发布配置
云应用中心SDK目前是把module发布到Maven，以aar组件的方式提供给各个业务线的。
以下是发布组件的注意事项：

1、<u>**修改isPublishComponent配置**</u>
2、<u>**更改组件版本号**</u>
3、<u>**组件发布顺序**</u>
4、<u>**维护华为云应用SDK**</u>
5、<u>**uploadArchives**</u>

##### 修改isPublishComponent配置
**isPublishComponent说明：
true:发布组件
false:本地module依赖**
发布组件时候，需要先把gradle.properties文件isPublishComponent的属性设置为true。组件发布完毕，请及时改回false，避免上传到远端仓库。（PS:可以放到local.properties，该文件一般是git忽略规则文件）
```
isPublishComponent=true
```

##### 更改组件版本号
一般发布组件只需要需要修改对应module的版本号即可，避免造成混乱，版本号只可递增，不可降版本。各module版本号可以不一致，要做好版本日志管理。
* **basic-core**
basic-core模块配置版本号
```
def CORE_VERSION_NAME='1.0.5'
```
* **module-common**
basic-core模块配置版本号
```
def COMMON_VERSION_NAME='1.0.5'
```
* **module-main**
basic-core模块配置版本号
```
def MAIN_VERSION_NAME='1.0.5'
```

* **cloudapp**
华为云应用SDK配置版本号
```
def CLOUD_APP_SDK_VERSION_NAME='8.40'
```

##### 组件发布顺序
根据我们工程的**依赖关系basic-core->module-common->module-main**
**请严格按照以下组件的顺序来发布。**
1、basic-core
2、module-common
3、module-main

##### 维护华为云应用SDK
如果华为侧提供了新版本的aar，上传到yfbzy-release仓库，以远程aar方式集成到module-main工程里面。
**发布步骤如下图：**
![](http://cmic.tools.bigcloudsys.cn/gitlab/HeCloudPhone/Android/CloudAppsCenter/blob/master/image/%E4%B8%8A%E4%BC%A0%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%BA%94%E7%94%A8SDK.png)
配置引用版本：
![](http://cmic.tools.bigcloudsys.cn/gitlab/HeCloudPhone/Android/CloudAppsCenter/blob/master/image/%E4%BF%AE%E6%94%B9%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%BA%94%E7%94%A8SDK%E7%89%88%E6%9C%AC.png)



##### uploadArchives
修改完工程之后build工程，按照<u>**组件发布顺序**</u>把组件发布到Maven
**modulexxx -> Tasks -> uploadArchives**  
![](http://cmic.tools.bigcloudsys.cn/gitlab/HeCloudPhone/Android/CloudAppsCenter/blob/master/image/%E5%8F%91%E5%B8%83%E7%BB%84%E4%BB%B6%E6%B5%81%E7%A8%8B.png)


### 业务线依赖配置
* **引用**
```
implementation 'com.chinamobile.cloudappscenter:main:1.0.8'
```
* **仓库地址**
```
allprojects {
    repositories {
        ...
        maven { url "http://cmic.tools.bigcloudsys.cn/nexus/repository/yfbzy-release/" }
        maven { url 'https://jitpack.io' }
        ....
    }
}
```
* **常见问题**
    **1、业务工程跟aar组件minSdkVersion不一致**
    aar的依赖会出现跟业务线的minSdkVersion版本不一致的问题，需要在<manifest>节点下面添加下面的配置
    ```
    <uses-sdk tools:overrideLibrary="com.chinamobile.cloudappscenter.main,com.chinamobile.common,com.chinamobile.baselib,com.luck.picture.lib,com.yalantis.ucrop"/>
    ```
    **2、资源属性冲突**
    业务线工程一般都极具复杂性，我们做好模块之间资源的前缀隔离，还是会难免出现一些资源属性会跟我们的组件属性有冲突的情况，可以让业务方使用tools:replace来覆盖我们组件的属性。例如
    在<application 节点添加对应资源的属性
    ```
    tools:replace="android:icon,android:roundIcon,android:theme"
    ```

    **3、重复依赖、依赖版本不一致怎么办？**
    业务工程可能会出现跟我们组件使用了相同的依赖或者不同版本的依赖，可以使用exclude去除SDK里面的dependency，如果遇到跟业务方的api不一致，我们就得适配业务方的版本了。
    例如智云遇到的tablayout冲突
    ```
        implementation ('com.chinamobile.cloudappscenter:main:1.0.2') {
            exclude group: 'com.flyco.tablayout'
        }
    ```